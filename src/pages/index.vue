<template>
  <div class="home-page">
    <div class="title">
      <span>ÂæóÂàÜÔºö{{score}}</span>
    </div>
    <scroll @scrollTop="scrollTop" @scrollBottom="scrollBottom" @scrollLeft="scrollLeft" @scrollRight="scrollRight">
      <div class="main-content">
        <div class="item" :class="`item_${item}`" v-for="(item, index) in datas" :key="`${item}_${index}`">
          <div v-show="item" :class="transitionIndex == index ? 'bounce-enter-active': ''">{{item}}</div>
        </div>
      </div>
    </scroll>
    <div class="action">
      <button class="restart" @click="reStart">ÈáçÊñ∞ÂºÄÂßã</button>
      <button class="max-score" @click="showScore">ÂéÜÂè≤ÊúÄÈ´òÂàÜ</button>
    </div>
    <div class="model" v-show="!notShowDialog"  @click="notShowDialog = true"></div>
    <div class="tips" v-show="!notShowDialog">
      <p class="head">{{dialogTitle}}</p>
      <p class="value">{{dialogTips}} {{emoji}}</p>
    </div>
    <div class="interjection" v-show="isInterject">{{interject}}</div>
    <fireworks v-show="isFireworks"></fireworks>
    <span class="goBack" @click="goBack"></span>
  </div>
</template>

<style lang="stylus" scoped>
.home-page {
  user-select: none;
  background: #ded9cb;
  height: 100%;

  .title {
    text-align: center;
    line-height: 60px;
    font-size: 22px;
    font-family: cursive;
  }
  .main-content{
    background: #e7eadd;
    color: red;
    max-width: 400px;
    margin: 0 auto;
    padding: 5px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    
    .item {
      width: 80px;
      height: 80px;
      background: #CCC;
      margin: 5px;
      line-height: 80px;
      text-align: center;
      font-weight: bold;
      font-size: 24px;
      border-radius: 8px;
    }

    .item_2, .item_512 {
      background: #FFF;
      color: #000;
    }

    .item_4, .item_1024 {
      background: #d4dab1;
      color: #000;
    }

    .item_8, .item_2048 {
      background: #efcd8f;
      color: #FFF;
    }

    .item_16, .item_4096 {
      background: #d0c997;
      color: #FFF;
    }

    .item_32, .item_8192 {
      background: #d49d64;
      color: #FFF;
    }

    .item_64, .item_16384 {
      background: #f98a9a;
      color: #FFF;
    }

    .item_128, .item_32768 {
      background: #d897d6;
      color: #FFF;
    }

    .item_256 {
      background: #9799d8;
      color: #FFF;
    }
  }
  .action {
    margin-top: 10px;
    line-height: 70px;
    text-align: center;
    background: #ded4d4;

    button {
      height: 50px;
      border: none;
      color: #FFF;
      font-size: 18px;
      width: 140px;
      letter-spacing: 2px;
      border-radius: 10px;
    }

    .restart {
      background: #b38827;
      margin-right: 20px;
    }

    .max-score {
      background: #ccb934;
    }
  }
  .model {
    position: absolute;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    margin: auto;
  }
  .tips {
    width: 260px;
    height: 180px;
    background: #FFF;
    line-height: 180px;
    text-align: center;
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    margin: auto;
    margin-top: 50%;
    font-size: 28px;
    box-shadow: 2px 2px 1px #FFF;
    border-radius: 10px;

    .head, .value{
      height: 60px;
      line-height: 60px;
      margin: 0px;
      color: #d07e4f;
    }

    .head {
      margin-bottom: 10px;
      color: #000;
    }
  }
  .interjection {
    height: 40px;
    line-height: 40px;
    text-align: center;
    position: absolute;
    width: 100%;
    top: 30px;
    font-size: 24px;
    color: #26f10d;
    font-family: initial;
  }
  .goBack {
    position: absolute;
    width: 60px;
    top: 0px;
    height: 60px;
    line-height: 60px;
    background: url(".././assets/images/go_back.png") no-repeat;
    background-size: 40px 40px;
    background-position: center;
  }

  .bounce-enter-active{
    animation: bounce-in 0.5s;
  }
  @keyframes bounce-in {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.8);
    }
    100% {
      transform: scale(1);
    }
  }
}
@media screen and (max-width: 370px ) {
  .home-page {
    .main-content {
      .item {
        width: 65px;
        height: 65px;
        line-height: 65px;
      }
    }
  }
}
</style>

<script>
import loudlinks from '@/pages/utils/lounlinks.min.js'
import scroll from '@/components/common/scroll'
import fireworks from '@/components/common/fireworks'
export default {
  components: {
    scroll,
    fireworks
  },

  data () {
    return {
      palace: 4, // 4x4ÊñπÊ†º
      score: 0,
      maxScore: 0,

      datas: [],
      initData: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      randomNums: [2, 4],

      notShowDialog: true,
      dialogTips: 'Game Over',
      dialogTitle: '',
      interject: '',
      oldInterject: '',
      isInterject: false,
      isFireworks: false,
      emoji: 'üò≠',
      transitionIndex: 0,

      audioCtx: null //Èü≥È¢ëÂ£∞Èü≥
    }
  },

  mounted () {
    this.init()
  },

  methods: {
    init () {
      this.score = 0
      this.notShowDialog = true
      this.dialogTips = 'Game Over'
      this.dialogTitle = ''
      this.interject = ''
      this.oldInterject = ''
      this.isInterject = false
      this.isFireworks =  false
      const data = [...this.initData]
      this.datas = this.randomValue(data)
      if (window.localStorage.getItem('MAXSCORE')) {
        this.maxScore = window.localStorage.getItem('MAXSCORE')
      }
    },

    // ÈáçÊñ∞ÂºÄÂßã
    reStart () {
      this.init()
      document.getElementById('loud').click()
    },

    // Â±ïÁ§∫ÂéÜÂè≤ÊúÄÈ´òÂàÜ
    showScore () {
      this.notShowDialog = false
      this.dialogTips = this.maxScore
      this.dialogTitle = 'Max Score'
      const score = this.maxScore
      if (score > 1000) {
        this.emoji = 'üòê'
      }
      if (score > 2000) {
        this.emoji = 'üòâ'
      }
      if (score > 3000) {
        this.emoji = 'üòÄ'
      }
      if (score > 4000) {
        this.emoji = 'üòÇ'
      }
      if (score > 6000) {
        this.emoji = 'üòé'
      }
      if (score > 8000) {
        this.emoji = 'üòò'
      }
      if (score > 10000) {
        this.emoji = '‚ù§'
      }
      this.showFireworks()
    },

    // ÊòæÁ§∫Ê∏∏ÊàèÁªìÊùü
    showGameOver () {
      this.notShowDialog = false
      this.dialogTips = 'Game Over'
      this.dialogTitle = 'Sorry'
      this.emoji = 'üò≠'
    },

    // ÊòæÁ§∫ÁÉüËä±ÊïàÊûú
    showFireworks () {
      this.isFireworks = true
      setTimeout(() => {
        this.isFireworks = false
      }, 2000)
    },

    // ÊòØÂê¶ÊòæÁ§∫ÊÑüÂèπËØç
    isShowInterjection () {
      const score = this.score
      if (score > 500) {
        this.interject = 'Good'
      }
      if (score > 1000) {
        this.interject = 'Super'
      }
      if (score > 1500) {
        this.interject = 'Perfect'
      }
      if (score > 2000) {
        this.interject = 'Excellent'
      }
      if (score > 2500) {
        this.interject = 'Outstanding'
      }
      if (score > 3000) {
        this.interject = 'Well done'
      }
      if (score > 3500) {
        this.interject = 'Super star'
      }
      if (score > 4000) {
        this.interject = 'You are special'
      }
      if (score > 4500) {
        this.interject = 'You are so smart'
      }
      if (score > 6000) {
        this.interject = 'I envy you very much'
      }
      if (score > 8000) {
        this.interject = 'You are Outstanding'
      }
      if (score > 10000) {
        this.interject = 'You are invincible'
      }
      if (score > 15000) {
        this.interject = 'Ê±Ç‰Ω†Âà´Áé©‰∫Ü, ÊàëÂ∑≤ÁªèÊÉ≥‰∏çÂà∞ËØç‰∫Ü'
      }
      if (this.oldInterject !== this.interject) {
        this.isInterject = true
        this.isFireworks = true
        setTimeout(() => {
          this.isInterject = false
          this.isFireworks = false
          this.oldInterject = this.interject
        }, 2000)
      }
    },

    // ‰∏äÊªëÊàñËÄÖ‰∏ãÊªëÊó∂  ‰∫§Êç¢Á©∫ÂÄºÁöÑ‰ΩçÁΩÆ
    mergeData (copysDatas, palace) {
      const updateNullValue = () => {
        copysDatas.forEach((item, index) => {
          if (!item && index <= 11) {
            [copysDatas[index], copysDatas[index + palace]] = 
            [copysDatas[index + palace], copysDatas[index]]
          }
        })
      }
      updateNullValue(copysDatas)
      updateNullValue(copysDatas)
      updateNullValue(copysDatas)
      return copysDatas
    },

    // ÁîüÊàêÈöèÊú∫ÂÄº
    randomValue (datas) {
      let randomNull = []
      // ÂèñÂá∫ÊâÄ‰ª•Á©∫ÂÄºÁöÑ‰∏ãÊ†á
      datas.forEach((item, index) => {
        if (!item) {
          randomNull.push(index)
        }
      })
      // ÈöèÊú∫ÂèñÂá∫‰∏Ä‰∏™Á©∫ÂÄº‰∏ãÊ†á
      const randomNullIndex= Math.floor((Math.random() * randomNull.length))

      // Âú®randomNums‰∏≠ÈöèÊú∫ÂèñÂá∫‰∏Ä‰∏™Êï∞
      const randomNumIndex = Math.floor((Math.random() * this.randomNums.length))
      const randomNum = this.randomNums[randomNumIndex]
      // ÁªôÈöèÊú∫Âá∫ÁöÑÁ©∫ÂÄº Ë°•ÂÄº
      datas[randomNull[randomNullIndex]] = randomNum
      this.transitionIndex = randomNull[randomNullIndex]
      console.log(randomNull[randomNullIndex], 'randomNull[randomNullIndex]')
      return [...datas]
    },

    // ÊªëÂä®Êó∂Êï∞ÊçÆÂ§ÑÁêÜ
    scrollingActon (copysDatas, palace) {
      copysDatas = this.mergeData(copysDatas, palace)
      // ÊúâÁõ∏ÂêåÂÄºÂ§ÑÁêÜÁõ∏Âä†ÔºåÂπ∂ÈªòËÆ§ÂêéËÄÖÂÄº‰∏∫0
      let isSameValue = false
      copysDatas.forEach((value, index) => {
        if (index <= 11 && value && (copysDatas[index] == copysDatas[index + palace])) {
          copysDatas[index] = copysDatas[index] + copysDatas[index + palace]
          copysDatas[index + palace] = 0
          this.score += copysDatas[index]
          isSameValue = true
        }
      })

      // if (isSameValue) {
      //   // Áõ∏ÂêåÂÄºËß¶ÂèëÈü≥Êïà
      //   this.$refs.loudSlide.click()
      // } else {
      //   this.$refs.loudClick.click()
      // }
      document.getElementById('loud').click()
      
      if (this.score > this.maxScore) {
        this.maxScore = this.score
        window.localStorage.setItem('MAXSCORE', this.score)
      }

      this.isShowInterjection()
      
      // Âà§Êñ≠ÊñπÊ†ºÊòØÂê¶ÊúâÂèØÂêàÂπ∂ÁöÑÊï∞ÂÄº
      let notShowDialog = false
      if (!copysDatas.includes(0)) {
        copysDatas.forEach((item, index) => {
          // Âà§Êñ≠‰∏ä‰∏ãÊúâÊ≤°ÊúâÂÄºÁõ∏Á≠â
          if (index >= 4) {
            if (item === copysDatas[index - 4]) {
              notShowDialog = true
            }
          } else {
            if (item === copysDatas[index + 4]) {
              notShowDialog = true
            }
          }
          // Âà§Êñ≠Â∑¶Âè≥ÊúâÊ≤°ÊúâÂÄºÁõ∏Á≠â
          if ([4, 7, 11, 15].includes(index)) {
            if (item === copysDatas[index - 1]) {
              notShowDialog = true
            }
          } else {
            if (item === copysDatas[index + 1]) {
              notShowDialog = true
            }
          }
        })
        if (!notShowDialog) {
          this.showGameOver()
        }
      }
      copysDatas = this.mergeData([...copysDatas], palace)
      return copysDatas
    },

    // Âêë‰∏ãÊªëÂä®Êó∂Êï∞ÊçÆÂ§ÑÁêÜ
    fixScrollBottomData (datas, palace) {
      /**
       * Âêë‰∏ãÊªëÂä® Áõ∏ÂΩì‰∫éÊääÊï∞ÊçÆ‰∏ä‰∏ãÂèçËΩ¨
       * 
       * 1(13)    2(14)   3(15)    4(16)
         5(9)     6(10)   7(11)    8(12)
         9(5)     10(6)   11(7)    12(8)
         13(1)    14(2)   15(3)    16(4)
       */
      let copysDatas = []
      datas.forEach((item, index) => {
        if (index <= 3) {
          let num = (index + 3 * palace)
          copysDatas[num] = datas[index]
        }
        if (index > 3 && index <= 7) {
          let num = (index + palace)
          copysDatas[num] = datas[index]
        }

        if (index > 7 && index <= 11) {
          let num = (index - palace)
          copysDatas[num] = datas[index]
        }

        if (index > 11 && index <= 15) {
          let num = (index - 3 * palace)
          copysDatas[num] = datas[index]
        }
      })
      return copysDatas
    },

    // ÊÉ≥Âè≥ÊªëÂä®Êó∂Êï∞ÊçÆÂ§ÑÁêÜ
    fixScrollRightData (datas, palace) {
      /**
       * ÂæÄÂè≥ÊªëÂä®  Áõ∏ÂΩì‰∫éÊääÊï∞ÊçÆÈ°∫Êó∂ÈíàÊóãËΩ¨90Â∫¶
       * ÂéüÂÖàÁöÑ‰∏ãÊ†áÊéíÂ∫è 1 2 3  4   5 6  7  8    9 10 11 12  13 14 15 16
       * ÊóãËΩ¨Âêé‰∏ãÊ†áÊéíÂ∫è 4 8 12 16  3 7 11 15    2 6  10 14  1  5  9  13
        1(13)   2(9)   3(5)   4(1)
        5(14)   6(10)  7(6)   8(2)
        9(15)  10(11)  11(7)  12(3)
        13(16) 14(12)  15(8)  16(4)
      */
      let copysDatas = []
      datas.forEach((item, index) => {
        const dex = index + 1
        const remainder = dex % palace // ‰ΩôÊï∞
        const divisor = parseInt(dex / palace) //Èô§Êï∞
        const num = (palace - remainder) * palace + 1
        if (remainder === 0) {
          copysDatas[divisor - 1] = datas[index]
        }
        // ÁõÆÂâçÊòØ 4X4 ÂÆ´Ê†º  remainder‰ªé3ÂºÄÂßã
        if (remainder === 3 || remainder === 2 || remainder === 1) {
          copysDatas[divisor + num - 1] = datas[index]
        }
      })
      return copysDatas
    },

    scrollTop () {
      const palace = this.palace
      let copysDatas = [...this.datas]
      copysDatas = this.scrollingActon(copysDatas, palace)
      copysDatas = this.randomValue(copysDatas)
      this.datas = copysDatas
    },

    scrollBottom () {
      const palace = this.palace
      // ÊåâÁÖß4X4ÊñπÊ†º ÂèçËΩ¨ÂØπÁß∞Â§ÑÁêÜÊï∞ÊçÆ
      let copysDatas = this.fixScrollBottomData(this.datas, palace)
      copysDatas = this.scrollingActon(copysDatas, palace)
      // ÂÜçÂèçËΩ¨ ÂæóÂà∞ÂéüÂÖàÊï∞ÊçÆ
      copysDatas = this.fixScrollBottomData(copysDatas, palace)
      copysDatas = this.randomValue(copysDatas)
      this.datas = copysDatas
    },

    scrollRight () {
      const palace = this.palace
      // ÊåâÁÖß4X4ÊñπÊ†º ÂæóÂà∞È°∫Êó∂ÈíàÊóãËΩ¨90Â∫¶ÂêéÁöÑÊï∞ÊçÆ
      let copysDatas = this.fixScrollRightData(this.datas, palace)
      // ÊåâÁÖß‰∏äÊªëÊÉÖÂÜµÂ§ÑÁêÜ
      copysDatas = this.scrollingActon(copysDatas, palace)
      // ÂÜçÂ∞ÜÊï∞ÊçÆÂèçËΩ¨Âπ∂È°∫Êó∂ÈíàÊóãËΩ¨90Â∫¶ ÂæóÂà∞ÂéüÂÖàÁöÑÊï∞ÊçÆ
      copysDatas = this.fixScrollRightData(copysDatas.reverse(), palace)
      copysDatas = this.randomValue(copysDatas)
      this.datas = copysDatas
    },

    scrollLeft () {
      // ‰∏éÂè≥ÊªëÁ±ª‰ººÂ§ÑÁêÜ
      const palace = this.palace
      let copysDatas = this.fixScrollRightData(this.datas.reverse(), palace)
      copysDatas = this.scrollingActon(copysDatas, palace)
      copysDatas = this.fixScrollRightData(copysDatas, palace)
      copysDatas = this.randomValue(copysDatas)
      this.datas = copysDatas
    },

    goBack () {
      this.$router.push({
        path: '/'
      })
    }
  }
}
</script>
